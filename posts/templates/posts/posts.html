{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - Space Blog</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="{% static 'posts/styles.css' %}?v=4">
</head>

<body class="gradient-purple min-h-screen text-white">

    <!-- Fixed Top Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-purple-500/30">
        <div class="max-w-full px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo/Brand -->
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full gradient-button flex items-center justify-center">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </div>
                    <h1
                        class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        Space Blog
                    </h1>
                </div>

                <!-- User Greeting and Actions -->
                <div class="flex items-center space-x-4">
                    <!-- Greeting -->
                    <span class="hidden sm:block text-purple-200 font-medium">
                        Hello, <span class="text-white font-semibold">{{ user.username }}</span>
                    </span>

                    <!-- Post Button -->
                    <button id="openModalBtnTop"
                        class="gradient-button px-4 py-2 rounded-lg smooth-transition flex items-center space-x-2">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        <span class="hidden md:inline">Post</span>
                    </button>

                    <!-- Options Button -->
                    <button id="toggleSidebar"
                        class="glass px-4 py-2 rounded-lg smooth-transition hover:bg-purple-500/30 flex items-center space-x-2">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                        <span class="hidden md:inline">Options</span>
                    </button>

                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout Container -->
    <div class="flex pt-16 min-h-screen">

        <!-- Sidebar (Vertical Navigation Menu) -->
        <aside id="rightSidebar"
            class="hidden fixed right-0 top-16 bottom-0 w-64 glass border-l border-purple-500/30 overflow-y-auto transform translate-x-full transition-transform duration-300 ease-in-out z-40">
            <div class="p-6">
                <!-- Close Button -->
                <button id="closeSidebar"
                    class="lg:hidden absolute top-4 right-4 text-purple-300 hover:text-white smooth-transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <h2 class="text-sm font-semibold text-purple-300 uppercase tracking-wider mb-4">
                    Navigation
                </h2>

                <!-- Navigation Items -->
                <nav class="space-y-2">
                    <!-- My Posts -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="file-text" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">My Posts</span>
                    </a>

                    <!-- New Post -->
                    <a href="#" id="openModalSidebar"
                        class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="plus-circle" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">New Post</span>
                    </a>

                    <!-- Saved -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="bookmark" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Saved</span>
                    </a>

                    <!-- Discover -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="compass" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Discover</span>
                    </a>

                    <!-- Trending -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="trending-up" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Trending</span>
                    </a>

                    <!-- Favorites -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="heart" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Favorites</span>
                    </a>
                </nav>

                <!-- Divider -->
                <div class="my-6 border-t border-purple-500/30"></div>

                <!-- Additional Options -->
                <h2 class="text-sm font-semibold text-purple-300 uppercase tracking-wider mb-4">
                    More
                </h2>

                <nav class="space-y-2">
                    <!-- Analytics -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Analytics</span>
                    </a>

                    <!-- Profile -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="user" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Profile</span>
                    </a>

                    <!-- Logout -->
                    <a href="{% url 'posts:logout' %}"
                        class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="log-out" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Logout</span>
                    </a>
                </nav>
            </div>
        </aside>


        <!-- Main Content Area (Post Feed) -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8">
            <div class="max-w-4xl mx-auto">

                <!-- Page Header -->
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1
                            class="text-3xl sm:text-4xl font-bold mb-2 bg-gradient-to-r from-purple-300 via-pink-300 to-purple-300 bg-clip-text text-transparent">
                            Posts
                        </h1>
                        <p class="text-purple-200">
                            Share your thoughts with the community
                        </p>
                    </div>
                    <button id="openModalBtn"
                        class="gradient-button px-6 py-3 rounded-lg font-semibold smooth-transition hover:shadow-lg hover:shadow-purple-500/50 flex items-center space-x-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>New Post</span>
                    </button>
                </div>

                <!-- Posts List -->
                <div class="space-y-6">
                    {% if posts %}
                    {% for post in posts %}
                    <article
                        class="glass rounded-xl p-6 smooth-transition hover:bg-purple-500/10 hover:shadow-lg hover:shadow-purple-500/20">
                        <div class="flex items-start space-x-4">
                            <!-- Author Avatar -->
                            <div
                                class="w-12 h-12 rounded-full gradient-button flex items-center justify-center flex-shrink-0">
                                <i data-lucide="user" class="w-6 h-6"></i>
                            </div>

                            <!-- Post Content -->
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-semibold text-white">{{ post.author.username }}</span>
                                    <span class="text-purple-300 text-sm">â€¢ {{ post.created_at|timesince }} ago</span>
                                </div>
                                <h4 class="text-lg font-semibold text-white mb-2">
                                    {{ post.title }}
                                </h4>

                                {% if post.image %}
                                <div class="mb-4">
                                    <img src="{{ post.image.url }}" alt="{{ post.title }}"
                                        class="post-image rounded-lg max-w-full h-auto">
                                </div>
                                {% endif %}

                                <p class="text-purple-200 mb-4 post-description">
                                    {{ post.description }}
                                </p>

                                <!-- Post Actions -->
                                <div class="flex items-center space-x-6 text-sm">
                                    <button
                                        class="like-btn flex items-center space-x-2 smooth-transition {% if request.user in post.likes.all %}text-pink-500{% else %}text-purple-300 hover:text-purple-200{% endif %}"
                                        data-post-id="{{ post.id }}"
                                        data-is-liked="{% if request.user in post.likes.all %}true{% else %}false{% endif %}">
                                        <i data-lucide="heart"
                                            class="w-4 h-4 {% if request.user in post.likes.all %}fill-pink-500{% endif %}"></i>
                                        <span class="like-count">{{ post.likes.count }}</span>
                                        <span>likes</span>
                                    </button>
                                    <button
                                        class="comment-btn flex items-center space-x-2 text-purple-300 hover:text-purple-200 smooth-transition"
                                        data-post-id="{{ post.id }}" data-post-title="{{ post.title }}"
                                        data-post-author="{{ post.author.username }}"
                                        data-post-description="{{ post.description }}"
                                        data-post-image="{% if post.image %}{{ post.image.url }}{% endif %}"
                                        data-post-created="{{ post.created_at|timesince }}">
                                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                                        <span class="comment-count">{{ post.comments.count }}</span>
                                        <span>comments</span>
                                    </button>
                                    <button
                                        class="flex items-center space-x-2 text-purple-300 hover:text-purple-200 smooth-transition">
                                        <i data-lucide="share-2" class="w-4 h-4"></i>
                                        <span>Share</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                    {% else %}
                    <!-- Empty State -->
                    <div class="glass rounded-2xl p-12 text-center">
                        <div class="mb-6 relative inline-block">
                            <div
                                class="w-24 h-24 rounded-full gradient-button flex items-center justify-center sparkle">
                                <i data-lucide="file-text" class="w-12 h-12"></i>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold mb-3 text-white">
                            No Posts Yet
                        </h2>
                        <p class="text-purple-200 mb-6 max-w-md mx-auto">
                            Be the first to share something! Click the "New Post" button to create your first post.
                        </p>
                    </div>
                    {% endif %}
                </div>

            </div>
        </main>

    </div>

    <!-- Comments Modal -->
    <div id="commentsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content-large" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="text-2xl font-bold text-white">Post & Comments</h2>
                <button id="closeCommentsModalBtn" class="modal-close">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Modal Body - Two Panel Layout -->
            <div class="modal-body-two-panel">
                <!-- Left Panel: Post Content -->
                <div class="post-panel">
                    <div class="post-content-wrapper">
                        <!-- Post Author Info -->
                        <div class="flex items-center space-x-3 mb-4">
                            <div
                                class="w-12 h-12 rounded-full gradient-button flex items-center justify-center flex-shrink-0">
                                <i data-lucide="user" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-white" id="modalPostAuthor">Author</p>
                                <p class="text-sm text-purple-300" id="modalPostTime">Time</p>
                            </div>
                        </div>

                        <!-- Post Title -->
                        <h3 class="text-2xl font-bold text-white mb-4" id="modalPostTitle">Post Title</h3>

                        <!-- Post Image (if exists) -->
                        <div id="modalPostImageContainer" class="mb-4" style="display: none;">
                            <img id="modalPostImage" src="" alt="Post image" class="post-image rounded-lg w-full">
                        </div>

                        <!-- Post Description -->
                        <div class="prose prose-invert max-w-none">
                            <p class="text-purple-200 leading-relaxed" id="modalPostDescription">
                                Post description will appear here...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Comments Section -->
                <div class="comments-panel">
                    <!-- Comments Header -->
                    <div class="comments-header">
                        <h3 class="text-lg font-semibold text-white flex items-center space-x-2">
                            <i data-lucide="message-circle" class="w-5 h-5 text-purple-400"></i>
                            <span>Comments</span>
                        </h3>
                    </div>

                    <!-- Comments List -->
                    <div class="comments-list" id="commentsList">
                        <!-- Comments will be loaded here -->
                        <div class="text-center text-purple-300 py-8">
                            <i data-lucide="message-square" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                            <p>No comments yet. Be the first to comment!</p>
                        </div>
                    </div>

                    <!-- Comment Input Area -->
                    <div class="comment-input-area">
                        <form id="commentForm" class="flex flex-col space-y-3">
                            <textarea id="commentText" class="comment-textarea" placeholder="Write your comment..."
                                rows="3" required></textarea>
                            <button type="submit" class="btn-primary self-end">
                                <i data-lucide="send" class="w-4 h-4"></i>
                                <span>Post Comment</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="postModal" class="modal-overlay">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="text-2xl font-bold text-white">Create New Post</h2>
                <button id="closeModalBtn" class="modal-close">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data" id="postForm">
                    {% csrf_token %}

                    <!-- Title Field -->
                    <div class="form-group">
                        <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="form-error">{{ form.title.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Description Field -->
                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Content</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="form-error">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Image Field -->
                    <div class="form-group">
                        <label for="{{ form.image.id_for_label }}" class="form-label">Image (optional)</label>
                        <div class="file-input-wrapper">
                            {{ form.image }}
                        </div>
                        {% if form.image.errors %}
                        <div class="form-error">{{ form.image.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Topics Field -->
                    <div class="form-group">
                        <label class="form-label">Choose up to 3 topics</label>
                        <div class="topics-container" id="topicsContainer">
                            {% for choice in form.topics %}
                            <div class="topic-checkbox">
                                <input type="checkbox" name="{{ form.topics.name }}" value="{{ choice.data.value }}"
                                    id="{{ choice.id_for_label }}" {% if choice.data.selected %}checked{% endif %}>
                                <label for="{{ choice.id_for_label }}" class="topic-label">
                                    {{ choice.choice_label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.topics.errors %}
                        <div class="form-error">{{ form.topics.errors.0 }}</div>
                        {% endif %}
                        <div id="topicLimitWarning" class="topic-warning" style="display: none;">
                            You can only select up to 3 topics
                        </div>
                    </div>

                    <!-- Published Field -->
                    <div class="form-group-checkbox">
                        {{ form.is_published }}
                        <label for="{{ form.is_published.id_for_label }}" class="checkbox-label">
                            Publish immediately
                        </label>
                        {% if form.is_published.errors %}
                        <div class="form-error">{{ form.is_published.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Submit Button -->
                    <div class="modal-footer">
                        <button type="button" id="cancelBtn" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            <i data-lucide="send" class="w-5 h-5"></i>
                            <span>Publish Post</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();

        // Sidebar toggle functionality
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const rightSidebar = document.getElementById('rightSidebar');

        function openSidebar() {
            rightSidebar.classList.remove('hidden');
            setTimeout(() => {
                rightSidebar.classList.remove('translate-x-full');
            }, 10);
            lucide.createIcons();
        }

        function closeSidebar() {
            rightSidebar.classList.add('translate-x-full');
            setTimeout(() => {
                rightSidebar.classList.add('hidden');
            }, 300);
        }

        toggleSidebarBtn.addEventListener('click', () => {
            if (rightSidebar.classList.contains('hidden') || rightSidebar.classList.contains('translate-x-full')) {
                openSidebar();
            } else {
                closeSidebar();
            }
        });

        closeSidebarBtn.addEventListener('click', closeSidebar);

        document.addEventListener('click', (e) => {
            if (!rightSidebar.contains(e.target) &&
                !toggleSidebarBtn.contains(e.target) &&
                !rightSidebar.classList.contains('hidden') &&
                !rightSidebar.classList.contains('translate-x-full')) {
                closeSidebar();
            }
        });

        // Modal functionality
        const modal = document.getElementById('postModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const openModalBtnTop = document.getElementById('openModalBtnTop');
        const openModalSidebar = document.getElementById('openModalSidebar');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        function openModal() {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => lucide.createIcons(), 10);
        }

        function closeModal() {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        openModalBtn.addEventListener('click', openModal);
        openModalBtnTop.addEventListener('click', openModal);
        openModalSidebar.addEventListener('click', (e) => {
            e.preventDefault();
            openModal();
            closeSidebar();
        });
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                closeModal();
            }
        });

        // Topic selection limit (max 3)
        const topicCheckboxes = document.querySelectorAll('.topic-checkbox input[type="checkbox"]');
        const topicWarning = document.getElementById('topicLimitWarning');
        const MAX_TOPICS = 3;

        function updateTopicSelection() {
            const checkedCount = document.querySelectorAll('.topic-checkbox input[type="checkbox"]:checked').length;

            if (checkedCount >= MAX_TOPICS) {
                // Disable ONLY unchecked boxes, keep checked ones clickable for deselection
                topicCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.parentElement.classList.add('topic-disabled');
                    } else {
                        // Keep checked boxes enabled so they can be deselected
                        checkbox.disabled = false;
                        checkbox.parentElement.classList.remove('topic-disabled');
                    }
                });
                // Show warning only if somehow more than max were selected
                if (checkedCount > MAX_TOPICS) {
                    topicWarning.style.display = 'block';
                } else {
                    topicWarning.style.display = 'none';
                }
            } else {
                // Enable all boxes when under the limit
                topicCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.parentElement.classList.remove('topic-disabled');
                });
                topicWarning.style.display = 'none';
            }
        }

        topicCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateTopicSelection);
        });

        // ============================================
        // LIKE FUNCTIONALITY WITH AJAX
        // ============================================

        // Get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // Handle like button clicks
        document.querySelectorAll('.like-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();

                const postId = this.getAttribute('data-post-id');
                const isLiked = this.getAttribute('data-is-liked') === 'true';
                const heartIcon = this.querySelector('i[data-lucide="heart"]');
                const likeCountSpan = this.querySelector('.like-count');

                // Send AJAX request
                fetch(`/posts/like/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => response.json())
                    .then(data => {
                        // Update the like count
                        likeCountSpan.textContent = data.likes_count;

                        // Update the button state
                        this.setAttribute('data-is-liked', data.is_liked);

                        if (data.is_liked) {
                            // Liked - change to pink/filled
                            this.classList.remove('text-purple-300', 'hover:text-purple-200');
                            this.classList.add('text-pink-500');
                            heartIcon.classList.add('fill-pink-500');
                        } else {
                            // Unliked - change back to purple/outlined
                            this.classList.remove('text-pink-500');
                            this.classList.add('text-purple-300', 'hover:text-purple-200');
                            heartIcon.classList.remove('fill-pink-500');
                        }

                        // Re-initialize lucide icons to apply fill changes
                        lucide.createIcons();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });

        // ============================================
        // COMMENTS MODAL FUNCTIONALITY
        // ============================================

        const commentsModal = document.getElementById('commentsModal');
        const closeCommentsModalBtn = document.getElementById('closeCommentsModalBtn');
        let currentPostId = null;

        /**
         * Opens the comments modal and loads post data
         * @param {number} postId - The ID of the post to display
         */
        function openCommentModal(postId) {
            currentPostId = postId;
            const commentBtn = document.querySelector(`.comment-btn[data-post-id="${postId}"]`);

            if (!commentBtn) return;

            // Get post data from button attributes
            const postTitle = commentBtn.getAttribute('data-post-title');
            const postAuthor = commentBtn.getAttribute('data-post-author');
            const postDescription = commentBtn.getAttribute('data-post-description');
            const postImage = commentBtn.getAttribute('data-post-image');
            const postCreated = commentBtn.getAttribute('data-post-created');

            // Populate modal with post data
            document.getElementById('modalPostTitle').textContent = postTitle;
            document.getElementById('modalPostAuthor').textContent = postAuthor;
            document.getElementById('modalPostTime').textContent = postCreated + ' ago';
            document.getElementById('modalPostDescription').textContent = postDescription;

            // Handle post image
            const imageContainer = document.getElementById('modalPostImageContainer');
            const imageElement = document.getElementById('modalPostImage');
            if (postImage) {
                imageElement.src = postImage;
                imageContainer.style.display = 'block';
            } else {
                imageContainer.style.display = 'none';
            }

            // Load comments (AJAX)
            loadComments(postId);

            // Show modal
            commentsModal.style.display = 'flex';
            setTimeout(() => {
                commentsModal.classList.add('active');
                lucide.createIcons();
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        /**
         * Closes the comments modal
         */
        function closeCommentModal() {
            commentsModal.classList.remove('active');
            setTimeout(() => {
                commentsModal.style.display = 'none';
            }, 300);
            document.body.style.overflow = 'auto';
            currentPostId = null;
        }

        /**
         * Loads comments from server via AJAX
         * @param {number} postId - The ID of the post
         */
        function loadComments(postId) {
            const commentsList = document.getElementById('commentsList');

            // Show loading state
            commentsList.innerHTML = '<div class="text-center text-purple-300 py-8"><i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin"></i><p class="mt-2">Loading comments...</p></div>';
            lucide.createIcons();

            // Fetch comments from server
            fetch(`/posts/${postId}/comments/`)
                .then(response => response.json())
                .then(data => {
                    commentsList.innerHTML = '';

                    if (data.comments.length === 0) {
                        commentsList.innerHTML = '<div class="text-center text-purple-300 py-8"><i data-lucide="message-square" class="w-12 h-12 mx-auto mb-3 opacity-50"></i><p>No comments yet. Be the first to comment!</p></div>';
                    } else {
                        data.comments.forEach(comment => {
                            addCommentToDOM(comment);
                        });
                    }

                    lucide.createIcons();
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    commentsList.innerHTML = '<div class="text-center text-red-400 py-8"><p>Error loading comments. Please try again.</p></div>';
                });
        }

        /**
         * Adds a comment element to the DOM
         * @param {Object} comment - Comment data
         */
        function addCommentToDOM(comment) {
            const commentsList = document.getElementById('commentsList');

            // Remove "no comments" message if exists
            const noCommentsMsg = commentsList.querySelector('.text-center');
            if (noCommentsMsg) {
                commentsList.innerHTML = '';
            }

            const commentElement = document.createElement('div');
            commentElement.className = 'comment-item';
            commentElement.setAttribute('data-comment-id', comment.id);

            // Build delete button HTML if user has permission
            const deleteButtonHTML = comment.can_delete ? `
                <button class="delete-comment-btn text-red-400 hover:text-red-300 transition-colors ml-2" 
                        data-comment-id="${comment.id}"
                        title="Delete comment">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            ` : '';

            commentElement.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full gradient-button flex items-center justify-center flex-shrink-0">
                        <i data-lucide="user" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-semibold text-white text-sm">${comment.author}</span>
                            <span class="text-xs text-purple-400">${comment.time_ago} ago</span>
                            ${deleteButtonHTML}
                        </div>
                        <p class="text-sm text-purple-200">${comment.text}</p>
                    </div>
                </div>
            `;
            commentsList.appendChild(commentElement);
            lucide.createIcons();

            // Attach delete handler if button exists
            if (comment.can_delete) {
                const deleteBtn = commentElement.querySelector('.delete-comment-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function () {
                        deleteComment(comment.id);
                    });
                }
            }
        }

        /**
         * Deletes a comment via AJAX
         * @param {number} commentId - The ID of the comment to delete
         */
        function deleteComment(commentId) {
            // Confirm deletion
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }

            // Send AJAX request to delete
            fetch(`/posts/comment/${commentId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove comment from DOM
                        const commentElement = document.querySelector(`.comment-item[data-comment-id="${data.comment_id}"]`);
                        if (commentElement) {
                            commentElement.style.opacity = '0';
                            commentElement.style.transform = 'translateX(-20px)';
                            setTimeout(() => {
                                commentElement.remove();

                                // Check if comments list is empty
                                const commentsList = document.getElementById('commentsList');
                                if (commentsList.children.length === 0) {
                                    commentsList.innerHTML = '<div class="text-center text-purple-300 py-8"><i data-lucide="message-square" class="w-12 h-12 mx-auto mb-3 opacity-50"></i><p>No comments yet. Be the first to comment!</p></div>';
                                    lucide.createIcons();
                                }
                            }, 300);
                        }

                        // Update comment count in main page
                        const commentBtn = document.querySelector(`.comment-btn[data-post-id="${currentPostId}"]`);
                        if (commentBtn) {
                            const countSpan = commentBtn.querySelector('.comment-count');
                            if (countSpan) {
                                countSpan.textContent = data.comments_count;
                            }
                        }
                    } else {
                        alert(data.error || 'Error deleting comment. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting comment:', error);
                    alert('Error deleting comment. Please try again.');
                });
        }

        // Event listeners for modal
        closeCommentsModalBtn.addEventListener('click', closeCommentModal);

        // Close modal when clicking outside
        commentsModal.addEventListener('click', (e) => {
            if (e.target === commentsModal) {
                closeCommentModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && commentsModal.style.display === 'flex') {
                closeCommentModal();
            }
        });

        // Attach click handlers to all comment buttons
        document.querySelectorAll('.comment-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const postId = this.getAttribute('data-post-id');
                openCommentModal(postId);
            });
        });

        // Handle comment form submission
        document.getElementById('commentForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const commentText = document.getElementById('commentText').value.trim();

            if (!commentText) {
                return;
            }

            // Disable submit button to prevent double submission
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnHTML = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i><span>Posting...</span>';
            lucide.createIcons();

            // Send comment via AJAX
            fetch(`/posts/${currentPostId}/comment/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({ text: commentText })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Add new comment to DOM
                        addCommentToDOM(data.comment);

                        // Clear textarea
                        document.getElementById('commentText').value = '';

                        // Update comment count in main page
                        const commentBtn = document.querySelector(`.comment-btn[data-post-id="${currentPostId}"]`);
                        if (commentBtn) {
                            const countSpan = commentBtn.querySelector('.comment-count');
                            if (countSpan) {
                                countSpan.textContent = data.comments_count;
                            }
                        }

                        // Scroll to bottom of comments
                        const commentsList = document.getElementById('commentsList');
                        commentsList.scrollTop = commentsList.scrollHeight;
                    } else {
                        alert('Error posting comment. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error posting comment:', error);
                    alert('Error posting comment. Please try again.');
                })
                .finally(() => {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHTML;
                    lucide.createIcons();
                });
        });
    </script>

</body>

</html>