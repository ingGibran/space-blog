{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - Space Blog</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="{% static 'posts/styles.css' %}?v=3">
</head>

<body class="gradient-purple min-h-screen text-white">

    <!-- Fixed Top Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-purple-500/30">
        <div class="max-w-full px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo/Brand -->
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full gradient-button flex items-center justify-center">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </div>
                    <h1
                        class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        Space Blog
                    </h1>
                </div>

                <!-- User Greeting and Actions -->
                <div class="flex items-center space-x-4">
                    <!-- Greeting -->
                    <span class="hidden sm:block text-purple-200 font-medium">
                        Hello, <span class="text-white font-semibold">{{ user.username }}</span>
                    </span>

                    <!-- Post Button -->
                    <button id="openModalBtnTop"
                        class="gradient-button px-4 py-2 rounded-lg smooth-transition flex items-center space-x-2">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        <span class="hidden md:inline">Post</span>
                    </button>

                    <!-- Options Button -->
                    <button id="toggleSidebar"
                        class="glass px-4 py-2 rounded-lg smooth-transition hover:bg-purple-500/30 flex items-center space-x-2">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                        <span class="hidden md:inline">Options</span>
                    </button>

                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout Container -->
    <div class="flex pt-16 min-h-screen">

        <!-- Sidebar (Vertical Navigation Menu) -->
        <aside id="rightSidebar"
            class="hidden fixed right-0 top-16 bottom-0 w-64 glass border-l border-purple-500/30 overflow-y-auto transform translate-x-full transition-transform duration-300 ease-in-out z-40">
            <div class="p-6">
                <!-- Close Button -->
                <button id="closeSidebar"
                    class="lg:hidden absolute top-4 right-4 text-purple-300 hover:text-white smooth-transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <h2 class="text-sm font-semibold text-purple-300 uppercase tracking-wider mb-4">
                    Navigation
                </h2>

                <!-- Navigation Items -->
                <nav class="space-y-2">
                    <!-- My Posts -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="file-text" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">My Posts</span>
                    </a>

                    <!-- New Post -->
                    <a href="#" id="openModalSidebar"
                        class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="plus-circle" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">New Post</span>
                    </a>

                    <!-- Saved -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="bookmark" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Saved</span>
                    </a>

                    <!-- Discover -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="compass" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Discover</span>
                    </a>

                    <!-- Trending -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="trending-up" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Trending</span>
                    </a>

                    <!-- Favorites -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="heart" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Favorites</span>
                    </a>
                </nav>

                <!-- Divider -->
                <div class="my-6 border-t border-purple-500/30"></div>

                <!-- Additional Options -->
                <h2 class="text-sm font-semibold text-purple-300 uppercase tracking-wider mb-4">
                    More
                </h2>

                <nav class="space-y-2">
                    <!-- Analytics -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Analytics</span>
                    </a>

                    <!-- Profile -->
                    <a href="#" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="user" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Profile</span>
                    </a>

                    <!-- Logout -->
                    <a href="{% url 'posts:logout' %}"
                        class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg smooth-transition">
                        <i data-lucide="log-out" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-medium">Logout</span>
                    </a>
                </nav>
            </div>
        </aside>


        <!-- Main Content Area (Post Feed) -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8">
            <div class="max-w-4xl mx-auto">

                <!-- Page Header -->
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1
                            class="text-3xl sm:text-4xl font-bold mb-2 bg-gradient-to-r from-purple-300 via-pink-300 to-purple-300 bg-clip-text text-transparent">
                            Posts
                        </h1>
                        <p class="text-purple-200">
                            Share your thoughts with the community
                        </p>
                    </div>
                    <button id="openModalBtn"
                        class="gradient-button px-6 py-3 rounded-lg font-semibold smooth-transition hover:shadow-lg hover:shadow-purple-500/50 flex items-center space-x-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>New Post</span>
                    </button>
                </div>

                <!-- Posts List -->
                <div class="space-y-6">
                    {% if posts %}
                    {% for post in posts %}
                    <article
                        class="glass rounded-xl p-6 smooth-transition hover:bg-purple-500/10 hover:shadow-lg hover:shadow-purple-500/20">
                        <div class="flex items-start space-x-4">
                            <!-- Author Avatar -->
                            <div
                                class="w-12 h-12 rounded-full gradient-button flex items-center justify-center flex-shrink-0">
                                <i data-lucide="user" class="w-6 h-6"></i>
                            </div>

                            <!-- Post Content -->
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-semibold text-white">{{ post.author.username }}</span>
                                    <span class="text-purple-300 text-sm">â€¢ {{ post.created_at|timesince }} ago</span>
                                </div>
                                <h4 class="text-lg font-semibold text-white mb-2">
                                    {{ post.title }}
                                </h4>

                                {% if post.image %}
                                <div class="mb-4">
                                    <img src="{{ post.image.url }}" alt="{{ post.title }}"
                                        class="post-image rounded-lg max-w-full h-auto">
                                </div>
                                {% endif %}

                                <p class="text-purple-200 mb-4 post-description">
                                    {{ post.description }}
                                </p>

                                <!-- Post Actions -->
                                <div class="flex items-center space-x-6 text-sm">
                                    <button
                                        class="flex items-center space-x-2 text-purple-300 hover:text-purple-200 smooth-transition">
                                        <i data-lucide="heart" class="w-4 h-4"></i>
                                        <span>{{ post.likes_count }} likes</span>
                                    </button>
                                    <button
                                        class="flex items-center space-x-2 text-purple-300 hover:text-purple-200 smooth-transition">
                                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                                        <span>{{ post.comments.count }} comments</span>
                                    </button>
                                    <button
                                        class="flex items-center space-x-2 text-purple-300 hover:text-purple-200 smooth-transition">
                                        <i data-lucide="share-2" class="w-4 h-4"></i>
                                        <span>Share</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                    {% else %}
                    <!-- Empty State -->
                    <div class="glass rounded-2xl p-12 text-center">
                        <div class="mb-6 relative inline-block">
                            <div
                                class="w-24 h-24 rounded-full gradient-button flex items-center justify-center sparkle">
                                <i data-lucide="file-text" class="w-12 h-12"></i>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold mb-3 text-white">
                            No Posts Yet
                        </h2>
                        <p class="text-purple-200 mb-6 max-w-md mx-auto">
                            Be the first to share something! Click the "New Post" button to create your first post.
                        </p>
                    </div>
                    {% endif %}
                </div>

            </div>
        </main>

    </div>

    <!-- Modal Overlay -->
    <div id="postModal" class="modal-overlay">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="text-2xl font-bold text-white">Create New Post</h2>
                <button id="closeModalBtn" class="modal-close">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data" id="postForm">
                    {% csrf_token %}

                    <!-- Title Field -->
                    <div class="form-group">
                        <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="form-error">{{ form.title.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Description Field -->
                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Content</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="form-error">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Image Field -->
                    <div class="form-group">
                        <label for="{{ form.image.id_for_label }}" class="form-label">Image (optional)</label>
                        <div class="file-input-wrapper">
                            {{ form.image }}
                        </div>
                        {% if form.image.errors %}
                        <div class="form-error">{{ form.image.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Topics Field -->
                    <div class="form-group">
                        <label class="form-label">Choose up to 3 topics</label>
                        <div class="topics-container" id="topicsContainer">
                            {% for choice in form.topics %}
                            <div class="topic-checkbox">
                                {{ choice.tag }}
                                <label for="{{ choice.id_for_label }}" class="topic-label">
                                    {{ choice.choice_label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.topics.errors %}
                        <div class="form-error">{{ form.topics.errors.0 }}</div>
                        {% endif %}
                        <div id="topicLimitWarning" class="topic-warning" style="display: none;">
                            You can only select up to 3 topics
                        </div>
                    </div>

                    <!-- Published Field -->
                    <div class="form-group-checkbox">
                        {{ form.is_published }}
                        <label for="{{ form.is_published.id_for_label }}" class="checkbox-label">
                            Publish immediately
                        </label>
                        {% if form.is_published.errors %}
                        <div class="form-error">{{ form.is_published.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Submit Button -->
                    <div class="modal-footer">
                        <button type="button" id="cancelBtn" class="btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            <i data-lucide="send" class="w-5 h-5"></i>
                            <span>Publish Post</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();

        // Sidebar toggle functionality
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const rightSidebar = document.getElementById('rightSidebar');

        function openSidebar() {
            rightSidebar.classList.remove('hidden');
            setTimeout(() => {
                rightSidebar.classList.remove('translate-x-full');
            }, 10);
            lucide.createIcons();
        }

        function closeSidebar() {
            rightSidebar.classList.add('translate-x-full');
            setTimeout(() => {
                rightSidebar.classList.add('hidden');
            }, 300);
        }

        toggleSidebarBtn.addEventListener('click', () => {
            if (rightSidebar.classList.contains('hidden') || rightSidebar.classList.contains('translate-x-full')) {
                openSidebar();
            } else {
                closeSidebar();
            }
        });

        closeSidebarBtn.addEventListener('click', closeSidebar);

        document.addEventListener('click', (e) => {
            if (!rightSidebar.contains(e.target) &&
                !toggleSidebarBtn.contains(e.target) &&
                !rightSidebar.classList.contains('hidden') &&
                !rightSidebar.classList.contains('translate-x-full')) {
                closeSidebar();
            }
        });

        // Modal functionality
        const modal = document.getElementById('postModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const openModalBtnTop = document.getElementById('openModalBtnTop');
        const openModalSidebar = document.getElementById('openModalSidebar');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        function openModal() {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => lucide.createIcons(), 10);
        }

        function closeModal() {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        openModalBtn.addEventListener('click', openModal);
        openModalBtnTop.addEventListener('click', openModal);
        openModalSidebar.addEventListener('click', (e) => {
            e.preventDefault();
            openModal();
            closeSidebar();
        });
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                closeModal();
            }
        });

        // Topic selection limit (max 3)
        const topicCheckboxes = document.querySelectorAll('.topic-checkbox input[type="checkbox"]');
        const topicWarning = document.getElementById('topicLimitWarning');
        const MAX_TOPICS = 3;

        function updateTopicSelection() {
            const checkedCount = document.querySelectorAll('.topic-checkbox input[type="checkbox"]:checked').length;

            if (checkedCount >= MAX_TOPICS) {
                // Disable ONLY unchecked boxes, keep checked ones clickable for deselection
                topicCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.parentElement.classList.add('topic-disabled');
                    } else {
                        // Keep checked boxes enabled so they can be deselected
                        checkbox.disabled = false;
                        checkbox.parentElement.classList.remove('topic-disabled');
                    }
                });
                // Show warning only if somehow more than max were selected
                if (checkedCount > MAX_TOPICS) {
                    topicWarning.style.display = 'block';
                } else {
                    topicWarning.style.display = 'none';
                }
            } else {
                // Enable all boxes when under the limit
                topicCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.parentElement.classList.remove('topic-disabled');
                });
                topicWarning.style.display = 'none';
            }
        }

        topicCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateTopicSelection);
        });
    </script>

</body>

</html>